name: CD Pipeline

on:
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    name: ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
    env:
      # GitHub Packages ì¸ì¦ì„ ìœ„í•œ í™˜ê²½ë³€ìˆ˜
      USERNAME: ${{ github.actor }}
      GITHUB_PACKAGES_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“‹ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        run: |
          # ê¸°ë³¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "GOOGLE_CHAT_WEBHOOK_URL=${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" >> $GITHUB_ENV

          SERVICE_NAME=erp-service

          # ECR ë¦¬í¬ì§€í† ë¦¬ ì„¤ì • (primes/ì„œë¹„ìŠ¤ëª… í˜•ì‹)
          if [ -n "${{ secrets.ECR_REPOSITORY }}" ]; then
            echo "ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes/erp-service
            echo "ECR_REPOSITORY=primes/${SERVICE_NAME}" >> $GITHUB_ENV
            echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: primes/${SERVICE_NAME}"
          fi

          # ECS í´ëŸ¬ìŠ¤í„° ì„¤ì •
          if [ -n "${{ secrets.ECS_CLUSTER }}" ]; then
            echo "ECS_CLUSTER=${{ secrets.ECS_CLUSTER }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes
            echo "ECS_CLUSTER=primes" >> $GITHUB_ENV
            echo "âœ… ECS í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: primes"
          fi

          # ECS ì„œë¹„ìŠ¤ ì„¤ì •
          if [ -n "${{ secrets.ECS_SERVICE }}" ]; then
            echo "ECS_SERVICE=${{ secrets.ECS_SERVICE }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes-erp-service
            ECS_SERVICE="primes-${SERVICE_NAME}"
            echo "ECS_SERVICE=$ECS_SERVICE" >> $GITHUB_ENV
            echo "âœ… ECS ì„œë¹„ìŠ¤ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: $ECS_SERVICE"
          fi

          # ECS íƒœìŠ¤í¬ ì •ì˜ ì„¤ì •
          if [ -n "${{ secrets.ECS_TASK_DEFINITION }}" ]; then
            echo "ECS_TASK_DEFINITION=${{ secrets.ECS_TASK_DEFINITION }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes-erp
            ECS_TASK_DEF="primes-erp"
            echo "ECS_TASK_DEFINITION=$ECS_TASK_DEF" >> $GITHUB_ENV
            echo "âœ… ECS íƒœìŠ¤í¬ ì •ì˜ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: $ECS_TASK_DEF"
          fi

          # ECS ì»¨í…Œì´ë„ˆ ì´ë¦„ ì„¤ì •
          if [ -n "${{ secrets.ECS_CONTAINER_NAME }}" ]; then
            echo "ECS_CONTAINER_NAME=${{ secrets.ECS_CONTAINER_NAME }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: erp-service-container
            ECS_CONTAINER="${SERVICE_NAME}-container"
            echo "ECS_CONTAINER_NAME=$ECS_CONTAINER" >> $GITHUB_ENV
            echo "âœ… ECS ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: $ECS_CONTAINER"
          fi

          echo "=== ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ ==="
          echo "ì„œë¹„ìŠ¤ëª…: ${SERVICE_NAME}"
          echo "ECR_REPOSITORY: primes/${SERVICE_NAME}"
          echo "ECS_CLUSTER: primes"
          echo "ECS_SERVICE: primes-${SERVICE_NAME}"
          echo "ECS_TASK_DEFINITION: primes-erp"
          echo "ECS_CONTAINER_NAME: ${SERVICE_NAME}-container"

      - name: âš™ï¸ AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: "ğŸ” ë””ë²„ê¹…: í™˜ê²½ë³€ìˆ˜ í™•ì¸"
        run: |
          echo "=== í™˜ê²½ë³€ìˆ˜ ë””ë²„ê¹… ==="
          echo "AWS_REGION: ${{ env.AWS_REGION }}"
          echo "ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}"
          echo "ECS_CLUSTER: ${{ env.ECS_CLUSTER }}"
          echo "ECS_SERVICE: ${{ env.ECS_SERVICE }}"
          echo "ECS_TASK_DEFINITION: ${{ env.ECS_TASK_DEFINITION }}"
          echo "ECS_CONTAINER_NAME: ${{ env.ECS_CONTAINER_NAME }}"
          echo "=== GitHub ì¸ì¦ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ==="
          echo "USERNAME: $USERNAME"
          echo "TOKEN: $TOKEN"
          echo "ORG_GRADLE_PROJECT_gpr_user: $ORG_GRADLE_PROJECT_gpr_user"
          echo "ORG_GRADLE_PROJECT_gpr_key: $ORG_GRADLE_PROJECT_gpr_key"
          echo "GITHUB_ACTOR: ${{ github.actor }}"
          echo "GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}"
          echo "GITHUB_PACKAGES_TOKEN: $GITHUB_PACKAGES_TOKEN"
          echo "=== í™˜ê²½ë³€ìˆ˜ ê¸¸ì´ í™•ì¸ ==="
          echo "USERNAME ê¸¸ì´: ${#USERNAME}"
          echo "TOKEN ê¸¸ì´: ${#TOKEN}"
          echo "GITHUB_PACKAGES_TOKEN ê¸¸ì´: ${#GITHUB_PACKAGES_TOKEN}"
          echo "=== AWS ìê²©ì¦ëª… í™•ì¸ ==="
          aws sts get-caller-identity
          echo "=== ECR ì €ì¥ì†Œ ëª©ë¡ í™•ì¸ ==="
          aws ecr describe-repositories --region ${{ env.AWS_REGION }} || echo "ECR ì €ì¥ì†Œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨"

      - name: ğŸ”‘ Amazon ECR ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ·ï¸ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
        id: image-tag
        run: |
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "IMAGE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "IMAGE_TAG=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸ ë° ìƒì„±
        run: |
          echo "=== ECR ë¦¬í¬ì§€í† ë¦¬ í™•ì¸: ${{ env.ECR_REPOSITORY }} ==="
          if aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY }}" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ '${{ env.ECR_REPOSITORY }}'ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸ ECR ë¦¬í¬ì§€í† ë¦¬ '${{ env.ECR_REPOSITORY }}'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
            aws ecr create-repository \
              --repository-name "${{ env.ECR_REPOSITORY }}" \
              --region ${{ env.AWS_REGION }} \
              --image-scanning-configuration scanOnPush=true \
              --encryption-configuration encryptionType=AES256
            echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ '${{ env.ECR_REPOSITORY }}'ë¥¼ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
            aws ecr put-lifecycle-policy \
              --repository-name "${{ env.ECR_REPOSITORY }}" \
              --region ${{ env.AWS_REGION }} \
              --lifecycle-policy-text '{
                "rules": [
                  {
                    "rulePriority": 1,
                    "description": "Keep last 10 tagged images",
                    "selection": {
                      "tagStatus": "tagged",
                      "countType": "imageCountMoreThan",
                      "countNumber": 10
                    },
                    "action": { "type": "expire" }
                  },
                  {
                    "rulePriority": 2,
                    "description": "Delete untagged images older than 1 day",
                    "selection": {
                      "tagStatus": "untagged",
                      "countType": "sinceImagePushed",
                      "countUnit": "days",
                      "countNumber": 1
                    },
                    "action": { "type": "expire" }
                  }
                ]
              }' || echo "âš ï¸ ë¼ì´í”„ì‚¬ì´í´ ì •ì±… ì„¤ì • ì‹¤íŒ¨ (ë¬´ì‹œë¨)"
          fi

      - name: "ğŸ› ë””ë²„ê¹…: ì´ë¯¸ì§€ ë¹Œë“œ ì „ ë³€ìˆ˜ í™•ì¸"
        run: |
          echo "=== ë¹Œë“œ ì „ ë³€ìˆ˜ í™•ì¸ ==="
          echo "ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}"
          echo "ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}"
          echo "IMAGE_TAG: ${{ steps.image-tag.outputs.IMAGE_TAG }}"
          if [ -z "${{ steps.login-ecr.outputs.registry }}" ]; then echo "âŒ ECR_REGISTRYê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"; exit 1; fi
          if [ -z "${{ env.ECR_REPOSITORY }}" ]; then echo "âŒ ECR_REPOSITORYê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"; exit 1; fi
          if [ -z "${{ steps.image-tag.outputs.IMAGE_TAG }}" ]; then echo "âŒ IMAGE_TAGê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"; exit 1; fi
          EXPECTED_IMAGE_URI="${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.image-tag.outputs.IMAGE_TAG }}"
          echo "ì˜ˆìƒ ì´ë¯¸ì§€ URI: $EXPECTED_IMAGE_URI"

      - name: ğŸ—ï¸ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ
        id: build_image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
          IMAGE_TAG: ${{ steps.image-tag.outputs.IMAGE_TAG }}
        run: |
          echo "=== ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ==="
          echo "ECR_REGISTRY: $ECR_REGISTRY"
          echo "ECR_REPOSITORY: $ECR_REPOSITORY"
          echo "IMAGE_TAG: $IMAGE_TAG"
          if [ -z "$ECR_REGISTRY" ] || [ -z "$ECR_REPOSITORY" ] || [ -z "$IMAGE_TAG" ]; then
            echo "âŒ í•„ìˆ˜ ë³€ìˆ˜ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"; exit 1
          fi
          FULL_IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "ìµœì¢… ì´ë¯¸ì§€ URI: $FULL_IMAGE_URI"
          echo "=== ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ==="
          docker build \
            --build-arg GITHUB_USERNAME=${{ github.actor }} \
            --build-arg GITHUB_PACKAGES_TOKEN=${{ secrets.PAT_TOKEN }} \
            -t "$FULL_IMAGE_URI" .
          docker build \
            --build-arg GITHUB_USERNAME=${{ github.actor }} \
            --build-arg GITHUB_PACKAGES_TOKEN=${{ secrets.PAT_TOKEN }} \
            -t "$ECR_REGISTRY/$ECR_REPOSITORY:latest" .
          echo "=== ECR í‘¸ì‹œ ==="
          docker push "$FULL_IMAGE_URI"
          docker push "$ECR_REGISTRY/$ECR_REPOSITORY:latest"
          echo "=== ë¹Œë“œ ì™„ë£Œ ==="
          echo "âœ… ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ ë° ECR í‘¸ì‹œ ì™„ë£Œ: $FULL_IMAGE_URI"

  deploy-production:
    runs-on: ubuntu-latest
    name: ECS í”„ë¡œë•ì…˜ ë°°í¬
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'
    environment:
      name: production

    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“‹ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        run: |
          # ê¸°ë³¸ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          echo "AWS_REGION=${{ secrets.AWS_REGION }}" >> $GITHUB_ENV
          echo "GOOGLE_CHAT_WEBHOOK_URL=${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" >> $GITHUB_ENV

          SERVICE_NAME=erp-service

          # ECR ë¦¬í¬ì§€í† ë¦¬ ì„¤ì • (primes/ì„œë¹„ìŠ¤ëª… í˜•ì‹)
          if [ -n "${{ secrets.ECR_REPOSITORY }}" ]; then
            echo "ECR_REPOSITORY=${{ secrets.ECR_REPOSITORY }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes/erp-service
            echo "ECR_REPOSITORY=primes/${SERVICE_NAME}" >> $GITHUB_ENV
            echo "âœ… ECR ë¦¬í¬ì§€í† ë¦¬ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: primes/${SERVICE_NAME}"
          fi

          # ECS í´ëŸ¬ìŠ¤í„° ì„¤ì •
          if [ -n "${{ secrets.ECS_CLUSTER }}" ]; then
            echo "ECS_CLUSTER=${{ secrets.ECS_CLUSTER }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes
            echo "ECS_CLUSTER=primes" >> $GITHUB_ENV
            echo "âœ… ECS í´ëŸ¬ìŠ¤í„°ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: primes"
          fi

          # ECS ì„œë¹„ìŠ¤ ì„¤ì •
          if [ -n "${{ secrets.ECS_SERVICE }}" ]; then
            echo "ECS_SERVICE=${{ secrets.ECS_SERVICE }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes-erp-service
            ECS_SERVICE="primes-${SERVICE_NAME}"
            echo "ECS_SERVICE=$ECS_SERVICE" >> $GITHUB_ENV
            echo "âœ… ECS ì„œë¹„ìŠ¤ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: $ECS_SERVICE"
          fi

          # ECS íƒœìŠ¤í¬ ì •ì˜ ì„¤ì •
          if [ -n "${{ secrets.ECS_TASK_DEFINITION }}" ]; then
            echo "ECS_TASK_DEFINITION=${{ secrets.ECS_TASK_DEFINITION }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: primes-erp
            ECS_TASK_DEF="primes-erp"
            echo "ECS_TASK_DEFINITION=$ECS_TASK_DEF" >> $GITHUB_ENV
            echo "âœ… ECS íƒœìŠ¤í¬ ì •ì˜ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: $ECS_TASK_DEF"
          fi

          # ECS ì»¨í…Œì´ë„ˆ ì´ë¦„ ì„¤ì •
          if [ -n "${{ secrets.ECS_CONTAINER_NAME }}" ]; then
            echo "ECS_CONTAINER_NAME=${{ secrets.ECS_CONTAINER_NAME }}" >> $GITHUB_ENV
          else
            # ê¸°ë³¸ê°’: erp-service-container
            ECS_CONTAINER="${SERVICE_NAME}-container"
            echo "ECS_CONTAINER_NAME=$ECS_CONTAINER" >> $GITHUB_ENV
            echo "âœ… ECS ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ ì„¤ì •í–ˆìŠµë‹ˆë‹¤: $ECS_CONTAINER"
          fi

          echo "=== ì„¤ì •ëœ í™˜ê²½ë³€ìˆ˜ ==="
          echo "ì„œë¹„ìŠ¤ëª…: ${SERVICE_NAME}"
          echo "ECR_REPOSITORY: primes/${SERVICE_NAME}"
          echo "ECS_CLUSTER: primes"
          echo "ECS_SERVICE: primes-${SERVICE_NAME}"
          echo "ECS_TASK_DEFINITION: primes-erp"
          echo "ECS_CONTAINER_NAME: ${SERVICE_NAME}-container"

      - name: âš™ï¸ AWS ìê²© ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ” AWS ê³„ì • ID í™•ì¸
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID" >> $GITHUB_ENV
          echo "í˜„ì¬ AWS ê³„ì • ID: $AWS_ACCOUNT_ID"

      - name: ğŸ“¥ ì´ë¯¸ì§€ URIë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
        run: |
          # deploy ì¡ì—ì„œ ì´ë¯¸ì§€ ì •ë³´ë¥¼ ì¬êµ¬ì„± (build ì¡ê³¼ ë™ì¼í•œ ë¡œì§)
          ECR_REGISTRY="${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com"
          ECR_REPOSITORY="${{ env.ECR_REPOSITORY }}"

          # ì´ë¯¸ì§€ íƒœê·¸ ì¬ìƒì„± (build ì¡ê³¼ ë™ì¼í•œ ë¡œì§)
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            IMAGE_TAG="${GITHUB_REF#refs/tags/}"
          else
            IMAGE_TAG="${GITHUB_SHA::8}"
          fi

          DOCKER_IMAGE_URI="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "DOCKER_IMAGE_URI=$DOCKER_IMAGE_URI" >> $GITHUB_ENV
          echo "âœ… í™˜ê²½ë³€ìˆ˜ ì„¤ì •: DOCKER_IMAGE_URI=$DOCKER_IMAGE_URI"

      - name: "ğŸ” ë””ë²„ê¹…: ì´ë¯¸ì§€ URI í™•ì¸"
        run: |
          echo "=== í™˜ê²½ë³€ìˆ˜ ê¸°ë°˜ ì´ë¯¸ì§€ URI í™•ì¸ ==="
          echo "DOCKER_IMAGE_URI: ${{ env.DOCKER_IMAGE_URI }}"
          if [ -z "${{ env.DOCKER_IMAGE_URI }}" ]; then
            echo "âŒ DOCKER_IMAGE_URIê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤!"
            exit 1
          else
            echo "âœ… ì´ë¯¸ì§€ URI ì„¤ì • ì„±ê³µ!"
          fi

      - name: ğŸ—ï¸ ECS í´ëŸ¬ìŠ¤í„° í™•ì¸ ë° ìƒì„±
        run: |
          echo "=== ECS í´ëŸ¬ìŠ¤í„° í™•ì¸: ${{ env.ECS_CLUSTER }} ==="

          # ECS í´ëŸ¬ìŠ¤í„° ì¡´ì¬ í™•ì¸
          if aws ecs describe-clusters --clusters "${{ env.ECS_CLUSTER }}" --region ${{ env.AWS_REGION }} --query 'clusters[?status==`ACTIVE`]' --output text | grep -q "${{ env.ECS_CLUSTER }}"; then
            echo "âœ… ECS í´ëŸ¬ìŠ¤í„° '${{ env.ECS_CLUSTER }}'ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸ ECS í´ëŸ¬ìŠ¤í„° '${{ env.ECS_CLUSTER }}'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
            
            # ECS í´ëŸ¬ìŠ¤í„° ìƒì„±
            aws ecs create-cluster \
              --cluster-name "${{ env.ECS_CLUSTER }}" \
              --capacity-providers FARGATE \
              --default-capacity-provider-strategy capacityProvider=FARGATE,weight=1 \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… ECS í´ëŸ¬ìŠ¤í„° '${{ env.ECS_CLUSTER }}'ë¥¼ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
          fi

      - name: ğŸ“œ CloudWatch ë¡œê·¸ ê·¸ë£¹ í™•ì¸ ë° ìƒì„±
        run: |
          LOG_GROUP="/ecs/${{ env.ECS_TASK_DEFINITION }}"
          echo "=== CloudWatch Logs ë¡œê·¸ ê·¸ë£¹ í™•ì¸: $LOG_GROUP ==="
          EXISTS=$(aws logs describe-log-groups \
            --log-group-name-prefix "$LOG_GROUP" \
            --region ${{ env.AWS_REGION }} \
            --query "logGroups[?logGroupName=='$LOG_GROUP'] | length(@)" \
            --output text || echo 0)
          if [ "$EXISTS" != "0" ]; then
            echo "âœ… ë¡œê·¸ ê·¸ë£¹ '$LOG_GROUP'ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸ ë¡œê·¸ ê·¸ë£¹ '$LOG_GROUP'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
            aws logs create-log-group --log-group-name "$LOG_GROUP" --region ${{ env.AWS_REGION }}
            # ë³´ê´€ ê¸°ê°„ì„ 30ì¼ë¡œ ì„¤ì • (í•„ìš”ì‹œ ì¡°ì •)
            aws logs put-retention-policy --log-group-name "$LOG_GROUP" --retention-in-days 30 --region ${{ env.AWS_REGION }} || true
            echo "âœ… ë¡œê·¸ ê·¸ë£¹ '$LOG_GROUP' ìƒì„± ì™„ë£Œ"
          fi

      - name: ğŸ“ ECS íƒœìŠ¤í¬ ì •ì˜ í™•ì¸ ë° ìƒì„±
        run: |
          echo "=== ECS íƒœìŠ¤í¬ ì •ì˜ í™•ì¸: ${{ env.ECS_TASK_DEFINITION }} ==="

          # ECS íƒœìŠ¤í¬ ì •ì˜ ì¡´ì¬ í™•ì¸
          if aws ecs describe-task-definition --task-definition "${{ env.ECS_TASK_DEFINITION }}" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "âœ… ECS íƒœìŠ¤í¬ ì •ì˜ '${{ env.ECS_TASK_DEFINITION }}'ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸ ECS íƒœìŠ¤í¬ ì •ì˜ '${{ env.ECS_TASK_DEFINITION }}'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ íƒœìŠ¤í¬ ì •ì˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            
            # ECS íƒœìŠ¤í¬ ì‹¤í–‰ ì—­í•  í™•ì¸ ë° ìƒì„±
            EXECUTION_ROLE_NAME="ecsTaskExecutionRole"
            EXECUTION_ROLE_ARN="arn:aws:iam::${{ env.AWS_ACCOUNT_ID }}:role/$EXECUTION_ROLE_NAME"
            
            if ! aws iam get-role --role-name "$EXECUTION_ROLE_NAME" 2>/dev/null; then
              echo "âš ï¸ ECS íƒœìŠ¤í¬ ì‹¤í–‰ ì—­í• ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒì„±í•©ë‹ˆë‹¤..."
              
              # ì‹ ë¢° ì •ì±… ìƒì„±
              cat > trust-policy.json << TRUST_EOF
          {
            "Version": "2012-10-17",
            "Statement": [
              {
                "Effect": "Allow",
                "Principal": {
                  "Service": "ecs-tasks.amazonaws.com"
                },
                "Action": "sts:AssumeRole"
              }
            ]
          }
          TRUST_EOF
              
              # ì—­í•  ìƒì„±
              aws iam create-role \
                --role-name "$EXECUTION_ROLE_NAME" \
                --assume-role-policy-document file://trust-policy.json
              
              # ê´€ë¦¬í˜• ì •ì±… ì—°ê²°
              aws iam attach-role-policy \
                --role-name "$EXECUTION_ROLE_NAME" \
                --policy-arn "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
              
              echo "âœ… ECS íƒœìŠ¤í¬ ì‹¤í–‰ ì—­í• ì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
            else
              echo "âœ… ECS íƒœìŠ¤í¬ ì‹¤í–‰ ì—­í• ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
            fi
            
            # ê¸°ë³¸ íƒœìŠ¤í¬ ì •ì˜ ìƒì„±
            cat > initial-task-definition.json << EOF
          {
            "family": "${{ env.ECS_TASK_DEFINITION }}",
            "networkMode": "awsvpc",
            "requiresCompatibilities": ["FARGATE"],
            "cpu": "512",
            "memory": "1024",
            "executionRoleArn": "$EXECUTION_ROLE_ARN",
            "containerDefinitions": [
              {
                "name": "${{ env.ECS_CONTAINER_NAME }}",
                "image": "${{ env.DOCKER_IMAGE_URI }}",
                "portMappings": [
                  {
                    "containerPort": 8080,
                    "protocol": "tcp"
                  }
                ],
                "environment": [
                  {
                    "name": "SPRING_PROFILES_ACTIVE",
                    "value": "prod"
                  },
                  {
                    "name": "AWS_REGION",
                    "value": "${{ env.AWS_REGION }}"
                  }
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/${{ env.ECS_TASK_DEFINITION }}",
                    "awslogs-region": "${{ env.AWS_REGION }}",
                    "awslogs-stream-prefix": "ecs",
                    "awslogs-create-group": "true"
                  }
                },
                "healthCheck": {
                  "command": [
                    "CMD-SHELL",
                    "curl -f http://localhost:8080/actuator/health || exit 1"
                  ],
                  "interval": 30,
                  "timeout": 5,
                  "retries": 3,
                  "startPeriod": 60
                }
              }
            ]
          }
          EOF
            
            # íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
            aws ecs register-task-definition \
              --cli-input-json file://initial-task-definition.json \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… ECS íƒœìŠ¤í¬ ì •ì˜ '${{ env.ECS_TASK_DEFINITION }}'ë¥¼ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
          fi

      - name: ğŸ”§ ECS ì„œë¹„ìŠ¤ í™•ì¸ ë° ìƒì„±
        run: |
          echo "=== ECS ì„œë¹„ìŠ¤ í™•ì¸: ${{ env.ECS_SERVICE }} ==="

          # ECS ì„œë¹„ìŠ¤ ì¡´ì¬ í™•ì¸
          if aws ecs describe-services \
            --cluster "${{ env.ECS_CLUSTER }}" \
            --services "${{ env.ECS_SERVICE }}" \
            --region ${{ env.AWS_REGION }} \
            --query 'services[?status==`ACTIVE`]' \
            --output text | grep -q "${{ env.ECS_SERVICE }}"; then
            echo "âœ… ECS ì„œë¹„ìŠ¤ '${{ env.ECS_SERVICE }}'ê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸ ECS ì„œë¹„ìŠ¤ '${{ env.ECS_SERVICE }}'ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "ğŸ” ì‹¤ì œ í™•ì¸ëœ primes-erp-service-vmwe9vsl ì„¤ì •ì„ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤..."
            
            # ì‹¤ì œ AWS CLIë¡œ í™•ì¸ëœ primes-erp-service-vmwe9vsl ì„¤ì • ì‚¬ìš©
            SUBNETS="subnet-0bad7f28606eb72d8,subnet-087762f53021ab310,subnet-0d3b881c0e323fa94,subnet-08be52b1682fe02cd"
            SECURITY_GROUPS="sg-004ee46a44c808ccc"
            ASSIGN_PUBLIC_IP="ENABLED"
            DESIRED_COUNT="1"
            PLATFORM_VERSION="LATEST"
            
            # erp-service ì„œë¹„ìŠ¤ëª…ìœ¼ë¡œ Service Discovery ARN ë™ì  ì¡°íšŒ
            SERVICE_REGISTRY_ARN=$(aws servicediscovery list-services \
              --region ${{ env.AWS_REGION }} \
              --query 'Services[?Name==`erp-service`].Arn' \
              --output text)
            
            if [ -z "$SERVICE_REGISTRY_ARN" ]; then
              echo "âš ï¸ erp-service Service Discoveryë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìë™ ìƒì„±í•©ë‹ˆë‹¤..."
              
              # primes ë„¤ì„ìŠ¤í˜ì´ìŠ¤ í™•ì¸
              NAMESPACE_ID="ns-bf5gowpi2htxndrv"  # ì‹¤ì œ í™•ì¸ëœ primes ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ID
              
              # erp-service Service Discovery ìƒì„±
              SERVICE_REGISTRY_ARN=$(aws servicediscovery create-service \
                --name "erp-service" \
                --namespace-id "$NAMESPACE_ID" \
                --dns-config "RoutingPolicy=MULTIVALUE,DnsRecords=[{Type=A,TTL=5}]" \
                --health-check-custom-config "FailureThreshold=1" \
                --region ${{ env.AWS_REGION }} \
                --query 'Service.Arn' \
                --output text)
              
              if [ -n "$SERVICE_REGISTRY_ARN" ]; then
                echo "âœ… erp-service Service Discoveryë¥¼ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤: $SERVICE_REGISTRY_ARN"
              else
                echo "âŒ erp-service Service Discovery ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
                exit 1
              fi
            else
              echo "âœ… ê¸°ì¡´ erp-service Service Discoveryë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤: $SERVICE_REGISTRY_ARN"
            fi
            
            echo "ğŸ“‹ ì‚¬ìš©í•  ë„¤íŠ¸ì›Œí‚¹ ì„¤ì • (AWS CLIë¡œ í™•ì¸ëœ ì‹¤ì œ ê°’):"
            echo "  - í´ëŸ¬ìŠ¤í„°: ${{ env.ECS_CLUSTER }}"
            echo "  - ì„œë¸Œë„·: $SUBNETS"
            echo "  - ë³´ì•ˆê·¸ë£¹: $SECURITY_GROUPS"
            echo "  - Public IP í• ë‹¹: $ASSIGN_PUBLIC_IP"
            echo "  - Desired Count: $DESIRED_COUNT"
            echo "  - Platform Version: $PLATFORM_VERSION"
            echo "  - ì„œë¹„ìŠ¤ ê²€ìƒ‰ ë ˆì§€ìŠ¤íŠ¸ë¦¬: $SERVICE_REGISTRY_ARN"
            
            # ìƒˆ ECS ì„œë¹„ìŠ¤ ìƒì„± (Service Discovery í¬í•¨)
            aws ecs create-service \
              --cluster "${{ env.ECS_CLUSTER }}" \
              --service-name "${{ env.ECS_SERVICE }}" \
              --task-definition "${{ env.ECS_TASK_DEFINITION }}" \
              --desired-count "$DESIRED_COUNT" \
              --launch-type FARGATE \
              --platform-version "$PLATFORM_VERSION" \
              --network-configuration "awsvpcConfiguration={subnets=[$SUBNETS],securityGroups=[$SECURITY_GROUPS],assignPublicIp=$ASSIGN_PUBLIC_IP}" \
              --service-registries registryArn="$SERVICE_REGISTRY_ARN" \
              --deployment-configuration "deploymentCircuitBreaker={enable=true,rollback=true},maximumPercent=200,minimumHealthyPercent=100" \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… ECS ì„œë¹„ìŠ¤ '${{ env.ECS_SERVICE }}'ë¥¼ ì‹¤ì œ í™•ì¸ëœ ì„¤ì •ìœ¼ë¡œ ì„±ê³µì ìœ¼ë¡œ ìƒì„±í–ˆìŠµë‹ˆë‹¤."
            
            # ì„œë¹„ìŠ¤ê°€ ì•ˆì •ë  ë•Œê¹Œì§€ ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì•ˆì •í™”ë¥¼ ìœ„í•´ 30ì´ˆ ëŒ€ê¸°..."
            sleep 30
          fi

      - name: ğŸ“ ECS íƒœìŠ¤í¬ ì •ì˜ ë‹¤ìš´ë¡œë“œ
        run: |
          aws ecs describe-task-definition \
            --task-definition ${{ env.ECS_TASK_DEFINITION }} \
            --query taskDefinition > task-definition.json

      - name: íƒœìŠ¤í¬ ì •ì˜ ì»¨í…Œì´ë„ˆ ì´ë¦„ í™•ì¸
        run: |
          echo "=== íƒœìŠ¤í¬ ì •ì˜ ë‚´ìš© í™•ì¸ ==="
          cat task-definition.json | jq '.containerDefinitions[].name'

          # ì‹¤ì œ ì»¨í…Œì´ë„ˆ ì´ë¦„ ì¶”ì¶œ
          ACTUAL_CONTAINER_NAME=$(cat task-definition.json | jq -r '.containerDefinitions[0].name')
          echo "ì‹¤ì œ ì»¨í…Œì´ë„ˆ ì´ë¦„: $ACTUAL_CONTAINER_NAME"
          echo "ì„¤ì •ëœ ì»¨í…Œì´ë„ˆ ì´ë¦„: ${{ env.ECS_CONTAINER_NAME }}"

          # ì‹¤ì œ ì»¨í…Œì´ë„ˆ ì´ë¦„ì„ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
          echo "ACTUAL_CONTAINER_NAME=$ACTUAL_CONTAINER_NAME" >> $GITHUB_ENV

      - name: ğŸ”„ ìƒˆ ì´ë¯¸ì§€ URIë¡œ íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-definition.json
          container-name: ${{ env.ACTUAL_CONTAINER_NAME }}
          image: ${{ env.DOCKER_IMAGE_URI }}
          environment-variables: |
            SPRING_PROFILES_ACTIVE=prod
            AWS_REGION=${{ env.AWS_REGION }}

      - name: ğŸš€ Amazon ECS ì„œë¹„ìŠ¤ ë°°í¬
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: ğŸ“¢ Google Chat ë°°í¬ ì•Œë¦¼
        if: always()
        run: |
          STATUS_EMOJI="âœ…"
          STATUS_COLOR="#36a64f"
          STATUS_TEXT="ì„±ê³µ"

          if [ "${{ job.status }}" != "success" ]; then
            STATUS_EMOJI="âŒ"
            STATUS_COLOR="#ff0000"
            STATUS_TEXT="ì‹¤íŒ¨"
          fi

          # ì´ë¯¸ì§€ URIê°€ ë¹„ì–´ìˆì„ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
          IMAGE_URI="${{ env.DOCKER_IMAGE_URI }}"
          if [ -z "$IMAGE_URI" ]; then
            IMAGE_URI="ì´ë¯¸ì§€ ë¹Œë“œ ì‹¤íŒ¨ ë˜ëŠ” URI ì„¤ì •ë˜ì§€ ì•ŠìŒ"
          fi

          # ë¸Œëœì¹˜/íƒœê·¸ ì •ë³´
          REF_NAME="${{ github.ref_name }}"
          EVENT_NAME="${{ github.event_name }}"

          # ì›Œí¬í”Œë¡œìš° URL
          WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          MESSAGE=$(cat <<EOF
          {
            "cards": [{
              "header": {
                "title": "$STATUS_EMOJI ECS ë°°í¬ ì•Œë¦¼ - $STATUS_TEXT",
                "subtitle": "Primes erp API"
              },
              "sections": [{
                "widgets": [{
                  "keyValue": {
                    "topLabel": "ë°°í¬ ê²°ê³¼",
                    "content": "${{ job.status }} ($STATUS_TEXT)"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ë¸Œëœì¹˜/íƒœê·¸",
                    "content": "$REF_NAME ($EVENT_NAME)"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ì´ë¯¸ì§€ URI",
                    "content": "$IMAGE_URI"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "í™˜ê²½",
                    "content": "Production"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ECS í´ëŸ¬ìŠ¤í„°",
                    "content": "${{ env.ECS_CLUSTER || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ' }}"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ECS ì„œë¹„ìŠ¤",
                    "content": "${{ env.ECS_SERVICE || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ' }}"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ì»¤ë°‹ í•´ì‹œ",
                    "content": "${{ github.sha }}"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ì‘ì„±ì",
                    "content": "${{ github.actor }}"
                  }
                }, {
                  "keyValue": {
                    "topLabel": "ì‹¤í–‰ ì‹œê°„",
                    "content": "$(date '+%Y-%m-%d %H:%M:%S KST')"
                  }
                }]
              }, {
                "widgets": [{
                  "buttons": [{
                    "textButton": {
                      "text": "ğŸ”— ì›Œí¬í”Œë¡œìš° ë¡œê·¸ ë³´ê¸°",
                      "onClick": {
                        "openLink": {
                          "url": "$WORKFLOW_URL"
                        }
                      }
                    }
                  }]
                }]
              }]
            }]
          }
          EOF
          )

          echo "ğŸ“¤ Google Chat ë©”ì‹œì§€ ì „ì†¡ ì¤‘..."

          RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" -X POST "${{ env.GOOGLE_CHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "$MESSAGE")

          HTTP_STATUS=$(echo $RESPONSE | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          BODY=$(echo $RESPONSE | sed -E 's/HTTPSTATUS\:[0-9]{3}$//')

          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… Google Chat ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "âŒ Google Chat ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (HTTP $HTTP_STATUS)"
            echo "ì‘ë‹µ: $BODY"
          fi
