name: CI Pipeline

on:
  push:
    branches: [ develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    env:
      # GitHub Packages ì¸ì¦ì„ ìœ„í•œ í™˜ê²½ë³€ìˆ˜
      USERNAME: ${{ github.actor }}
      GITHUB_PACKAGES_TOKEN: ${{ secrets.PAT_TOKEN }}
    
    steps:
    - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: ğŸ” GitHub ì¸ì¦ í™˜ê²½ë³€ìˆ˜ ë””ë²„ê¹… (CI ë‹¨ê³„)
      run: |
        echo "=== CI ë‹¨ê³„: GitHub ì¸ì¦ í™˜ê²½ë³€ìˆ˜ í™•ì¸ ==="
        echo "USERNAME: $USERNAME"
        echo "GITHUB_PACKAGES_TOKEN: $GITHUB_PACKAGES_TOKEN"
        echo "GITHUB_ACTOR: ${{ github.actor }}"
        echo "=== í™˜ê²½ë³€ìˆ˜ ê¸¸ì´ í™•ì¸ ==="
        echo "USERNAME ê¸¸ì´: ${#USERNAME}"
        echo "GITHUB_PACKAGES_TOKEN ê¸¸ì´: ${#GITHUB_PACKAGES_TOKEN}"

    - name: â˜• Java 17 ì„¤ì •
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ“¦ Gradle ìºì‹œ ì„¤ì •
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: ğŸ”§ Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      run: chmod +x ./gradlew

    - name: ğŸ§ª í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë©”ì¸ í”„ë¡œì íŠ¸ë§Œ)
      run: ./gradlew :test --no-daemon --info
      env:
        SPRING_PROFILES_ACTIVE: test

    - name: ğŸ“Š ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ìƒì„±
      run: ./gradlew :jacocoTestReport --no-daemon
      if: success() || failure()

    - name: âœ… ì»¤ë²„ë¦¬ì§€ ê²€ì¦ (Service 100%)
      run: ./gradlew :jacocoTestCoverageVerification --no-daemon
      continue-on-error: true

    - name: ğŸ“ˆ í…ŒìŠ¤íŠ¸ ê²°ê³¼ í¼ë¸”ë¦¬ì‹œ
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: ğŸ“‹ í…ŒìŠ¤íŠ¸ ê²°ê³¼ (ë©”ì¸ í”„ë¡œì íŠ¸)
        path: build/test-results/test/*.xml
        reporter: java-junit